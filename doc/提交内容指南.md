# NFT 拍卖市场 - 提交内容指南

## 项目概述

本项目使用 Foundry 框架实现了一个完整的 NFT 拍卖市场，支持 ETH 和 ERC20 代币出价，集成 Chainlink 预言机进行价格转换，并使用 UUPS 代理模式实现合约升级。

## 提交内容清单

### 1. 代码

#### 1.1 智能合约代码

**核心合约：**
- `src/nft/NFTMarketplace.sol` - NFT 市场合约（ERC721 标准）
- `src/auction/Auction.sol` - 拍卖合约基类（抽象合约）
- `src/auction/AuctionV1.sol` - 拍卖合约 V1 版本（固定手续费率 2.5%）
- `src/auction/AuctionV2.sol` - 拍卖合约 V2 版本（动态手续费层级）
- `src/auction/PriceConverter.sol` - Chainlink 价格转换工具库

**接口定义：**
- `src/interface/IAuction.sol` - 拍卖合约接口
- `src/interface/INFTMarketplace.sol` - NFT 市场接口

#### 1.2 部署脚本

- `script/deploy/Deploy.s.sol` - 部署 AuctionV1 代理合约
- `script/upgrade/Upgrade.s.sol` - 升级脚本（V1 -> V2）
- `script/Interact.s.sol` - 合约交互脚本

#### 1.3 测试文件

- `test/nft/NFTMarketplace.t.sol` - NFT 市场测试
- `test/auction/Auction.t.sol` - 拍卖合约基本功能测试
- `test/auction/AuctionV2.t.sol` - 动态手续费功能测试

#### 1.4 配置文件

- `foundry.toml` - Foundry 项目配置
- `remappings.txt` - 路径重映射（如存在）

### 2. 测试报告

#### 2.1 测试覆盖范围

**NFT 市场测试（NFTMarketplace.t.sol）：**
- ✅ 合约初始化测试
- ✅ NFT 铸造功能测试
- ✅ NFT 销毁功能测试
- ✅ NFT 查询功能测试
- ✅ ERC721 标准接口测试
- ✅ 权限控制测试
- ✅ 元数据 URI 测试

**拍卖合约测试（Auction.t.sol）：**
- ✅ 合约初始化测试
- ✅ 创建拍卖测试
- ✅ ETH 出价测试
- ✅ ERC20 代币出价测试
- ✅ 结束拍卖测试
- ✅ 取消拍卖测试
- ✅ 提取资金测试
- ✅ Chainlink 价格转换测试
- ✅ 手续费计算测试
- ✅ 重入攻击保护测试
- ✅ 错误处理测试

**动态手续费测试（AuctionV2.t.sol）：**
- ✅ 手续费层级设置测试
- ✅ 动态手续费计算测试
- ✅ 不同金额区间费率测试
- ✅ 边界条件测试
- ✅ V1 到 V2 升级兼容性测试

#### 2.2 运行测试

```bash
# 进入项目目录
cd task3/nft-auction-market

# 运行所有测试
forge test -vv

# 运行测试并显示 gas 费用
forge test -vv --gas-report

# 运行特定测试合约
forge test --match-path test/auction/Auction.t.sol -vv

# 运行特定测试函数
forge test --match-test testCreateAuction -vv

# 生成测试覆盖率报告
forge coverage
```

#### 2.3 测试覆盖率目标

- **语句覆盖率**: 目标 > 90%
- **分支覆盖率**: 目标 > 85%
- **函数覆盖率**: 目标 > 95%

### 3. 部署地址

#### 3.1 本地测试网部署

部署到本地 Anvil 测试网的合约地址（示例）：

```bash
# 启动本地测试网
anvil

# 部署合约
forge script script/deploy/Deploy.s.sol:DeployAuction --rpc-url http://localhost:8545 --broadcast --verify
```

#### 3.2 Sepolia 测试网部署

部署到 Sepolia 测试网的合约地址：

```bash
# 部署到 Sepolia
forge script script/deploy/Deploy.s.sol:DeployAuction \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

**部署信息记录表：**

| 网络 | 代理合约地址 | 实现合约地址 | NFT 合约地址 | 部署日期 | 交易哈希 |
|------|------------|------------|------------|---------|---------|
| 本地 | 0x... | 0x... | 0x... | - | - |
| Sepolia | 待填写 | 待填写 | 待填写 | 待填写 | 待填写 |

#### 3.3 合约验证

```bash
# 验证合约（Etherscan）
forge verify-contract <PROXY_ADDRESS> \
  "src/auction/AuctionV1.sol:AuctionV1" \
  --chain-id 11155111 \
  --watch \
  --constructor-args $(cast abi-encode "constructor()" )

# 或者使用 forge script 的 --verify 标志自动验证
```

### 4. 文档

#### 4.1 项目文档

- `README.md` - 项目总体说明
- `doc/提交内容指南.md` - 本文档
- `doc/测试网部署指南.md` - 部署指南
- `doc/线上测试操作指南.md` - 测试操作指南

#### 4.2 功能说明文档

**核心功能：**

1. **NFT 管理**
   - 铸造 NFT
   - 销毁 NFT
   - 查询 NFT
   - 转移 NFT

2. **拍卖功能**
   - 创建拍卖（支持 ETH/ERC20）
   - 出价（ETH 或 ERC20 代币）
   - 结束拍卖
   - 取消拍卖
   - 提取资金

3. **价格转换**
   - ETH/USD 价格查询
   - ERC20/USD 价格查询
   - 实时价格验证

4. **合约升级**
   - UUPS 代理模式
   - 从 V1 升级到 V2
   - 数据保留

5. **手续费系统**
   - V1: 固定手续费率 2.5%
   - V2: 动态手续费层级
     - < 1000 USD: 3%
     - 1000-10000 USD: 2.5%
     - > 10000 USD: 2%

#### 4.3 部署步骤文档

详见 `doc/测试网部署指南.md`

#### 4.4 测试操作文档

详见 `doc/线上测试操作指南.md`

## 项目完整性检查

### ✅ 已完成功能

- [x] NFT 合约（ERC721 标准）
- [x] 拍卖合约（支持 ETH 和 ERC20）
- [x] Chainlink 预言机集成
- [x] UUPS 代理模式
- [x] 合约升级功能（V1 -> V2）
- [x] 动态手续费（额外挑战）
- [x] 重入保护
- [x] 完整的单元测试
- [x] 部署脚本
- [x] 交互脚本

### ⚠️ 可选增强功能（非必需）

- [ ] 前端界面（Web3 dApp）
- [ ] 集成测试（多合约交互）
- [ ] Gas 优化审计
- [ ] 第三方安全审计
- [ ] 多链部署支持
- [ ] 拍卖自动延期功能
- [ ] 出价提醒功能
- [ ] NFT 元数据托管

## 提交建议

### 代码仓库结构

```
solidity-task/
├── task3/
│   └── nft-auction-market/
│       ├── src/           # 智能合约
│       ├── test/          # 测试文件
│       ├── script/        # 部署脚本
│       ├── doc/           # 文档
│       ├── foundry.toml   # 配置文件
│       └── README.md      # 项目说明
└── README.md              # 总项目说明
```

### Git 提交规范

```bash
# 提交代码
git add .
git commit -m "完成 NFT 拍卖市场项目

- 实现 NFT 市场（ERC721）
- 实现拍卖合约（支持 ETH/ERC20）
- 集成 Chainlink 预言机
- 实现 UUPS 代理模式
- 实现 V1->V2 合约升级
- 实现动态手续费功能
- 编写完整的单元测试
- 编写部署和测试文档"
```

## 注意事项

1. **私钥安全**: 不要将私钥提交到代码仓库
2. **环境变量**: 使用 `.env` 文件管理敏感信息
3. **测试网 Gas**: 确保测试网账户有足够的测试 ETH
4. **合约验证**: 部署后及时在 Etherscan 验证合约
5. **文档更新**: 任何代码变更都要同步更新文档

## 联系方式

如有问题，请通过以下方式联系：
- GitHub Issues
- 项目文档
