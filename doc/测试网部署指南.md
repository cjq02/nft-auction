# NFT 拍卖市场 - 测试网部署指南

## 目录

1. [前置准备](#前置准备)
2. [环境配置](#环境配置)
3. [本地测试网部署](#本地测试网部署)
4. [Sepolia 测试网部署](#sepolia-测试网部署)
5. [合约验证](#合约验证)
6. [合约升级](#合约升级)
7. [故障排查](#故障排查)

---

## 前置准备

### 1.1 安装依赖

确保已安装以下工具：

```bash
# 安装 Foundry
curl -L https://foundry.paradigm.xyz | bash
foundryup

# 验证安装
forge --version
cast --version
anvil --version

# 安装 Node.js (可选，用于前端)
node --version
npm --version
```

### 1.2 获取测试网 ETH

**Sepolia 测试网：**
- 水龙头地址：https://sepoliafaucet.com/
- 备用水龙头：https://faucet.sepolia.ethfund.dev/
- Alvan 水龙头：https://sepoliafaucet.net/

**建议获取至少 0.5 ETH 用于测试和部署。**

### 1.3 获取 Chainlink 价格预言机地址

**Sepolia 网络的 Chainlink Price Feeds：**

| 代币对 | 合约地址 | decimals |
|-------|---------|---------|
| ETH/USD | 0x694AA1769357215DE4FAC081bf1f309aDC325306 | 8 |
| BTC/USD | 0x1b44F3514812d835EB1BDB0acB33d3fA3351Ee43 | 8 |
| USDC/USD | 0xA2F78ab2355Fe2Cd48370b735A90A59a274934F8 | 8 |

其他网络查询：https://docs.chain.link/data-feeds/price-feeds/addresses

---

## 环境配置

### 2.1 创建环境变量文件

在项目根目录创建 `.env` 文件：

```bash
# 进入项目目录
cd task3/nft-auction-market

# 创建 .env 文件
cat > .env << EOF
# 私钥（不要包含 0x 前缀）
PRIVATE_KEY=your_private_key_here

# RPC 端点
SEPOLIA_RPC_URL=https://eth-sepolia.g.alchemy.com/v2/your_api_key

# Etherscan API Key（用于合约验证）
ETHERSCAN_API_KEY=your_etherscan_api_key

# Chainlink 价格预言机地址（Sepolia）
ETH_PRICE_FEED=0x694AA1769357215DE4FAC081bf1f309aDC325306

# 手续费接收地址
FEE_RECIPIENT=your_wallet_address

# 已部署的代理合约地址（升级时使用）
PROXY_ADDRESS=deployed_proxy_address
EOF
```

### 2.2 获取 API Keys

**Alchemy API Key：**
1. 访问 https://www.alchemy.com/
2. 注册并创建新 App
3. 选择 Sepolia 网络
4. 复制 HTTP URL

**Etherscan API Key：**
1. 访问 https://etherscan.io/
2. 注册账号
3. 前往 API Keys 页面
4. 复制 API Key

### 2.3 安全提示

⚠️ **重要安全提醒：**

- **永远不要**将 `.env` 文件提交到 Git 仓库
- 确保已添加到 `.gitignore`：
  ```gitignore
  .env
  *.env
  ```

---

## 本地测试网部署

### 3.1 启动本地测试网

使用 Anvil 启动本地测试网：

```bash
# 方式 1: 启动默认测试网
anvil

# 方式 2: 指定端口和链 ID
anvil --port 8545 --chain-id 31337

# 方式 3: 模拟 Fork 主网（可选）
anvil --fork-url $SEPOLIA_RPC_URL
```

### 3.2 部署 NFT 合约

```bash
# 部署 NFTMarketplace
forge script script/deploy/DeployNFT.s.sol \
  --rpc-url http://localhost:8545 \
  --broadcast
```

如果没有现成脚本，可以创建：

```solidity
// script/deploy/DeployNFT.s.sol
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;

import "forge-std/Script.sol";
import "../../src/nft/NFTMarketplace.sol";

contract DeployNFT is Script {
    function run() external {
        uint256 deployerPrivateKey = vm.envUint("PRIVATE_KEY");
        address deployer = vm.addr(deployerPrivateKey);

        vm.startBroadcast(deployerPrivateKey);

        NFTMarketplace nft = new NFTMarketplace();
        console.log("NFTMarketplace deployed at:", address(nft));

        vm.stopBroadcast();
    }
}
```

### 3.3 部署拍卖合约

```bash
# 部署 AuctionV1 代理合约
forge script script/deploy/Deploy.s.sol \
  --rpc-url http://localhost:8545 \
  --broadcast
```

### 3.4 验证部署

```bash
# 查看合约代码
cast code <PROXY_ADDRESS> --rpc-url http://localhost:8545

# 查看合约 owner
cast call <PROXY_ADDRESS> "owner()(address)" --rpc-url http://localhost:8545
```

---

## Sepolia 测试网部署

### 4.1 部署前检查

```bash
# 检查账户余额
cast balance <YOUR_ADDRESS> --rpc-url $SEPOLIA_RPC_URL

# 检查 Gas 价格
cast gas-price --rpc-url $SEPOLIA_RPC_URL
```

### 4.2 部署 NFT 合约

```bash
# 部署到 Sepolia
forge script script/deploy/DeployNFT.s.sol \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### 4.3 部署拍卖合约

```bash
# 部署 AuctionV1 代理合约到 Sepolia
forge script script/deploy/Deploy.s.sol:DeployAuction \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY \
  --delay 15
```

**部署输出示例：**

```
==[Logs]==
Constructor called
Implementation deployed at: 0x1234...5678
Proxy deployed at: 0xabcd...efgh

==[Return]==
0x...

==[Summary]==
Total Gas Used: 1234567
   ...
✅ Deployment successful
```

### 4.4 记录部署信息

将以下信息保存到 `deployments/seopia.txt`：

```
部署日期: 2024-XX-XX
网络: Sepolia (Chain ID: 11155111)

NFT 合约地址: 0x...
Auction 实现合约地址: 0x...
Auction 代理合约地址: 0x...
部署者地址: 0x...
交易哈希: 0x...

Chainlink ETH/USD Feed: 0x694AA1769357215DE4FAC081bf1f309aDC325306
手续费率: 2.5% (250 basis points)
手续费接收者: 0x...
```

---

## 合约验证

### 5.1 自动验证（推荐）

在部署时使用 `--verify` 标志自动验证：

```bash
forge script script/deploy/Deploy.s.sol \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### 5.2 手动验证

如果自动验证失败，可以手动验证：

```bash
# 验证代理合约
forge verify-contract <PROXY_ADDRESS> \
  "@openzeppelin/contracts/proxy/ERC1967/ERC1967Proxy.sol:ERC1967Proxy" \
  --chain-id 11155111 \
  --watch

# 验证实现合约
forge verify-contract <IMPLEMENTATION_ADDRESS> \
  "src/auction/AuctionV1.sol:AuctionV1" \
  --chain-id 11155111 \
  --watch \
  --constructor-args $(cast abi-encode "constructor()" )
```

### 5.3 查看验证状态

访问 Etherscan 查看合约：
- Sepolia Etherscan: https://sepolia.etherscan.io/

输入合约地址后，应该能看到：
- ✅ 合约代码已验证
- ✅ Read Contract（读取功能）
- ✅ Write Contract（写入功能）

---

## 合约升级

### 6.1 升级到 V2

当需要将 AuctionV1 升级到 AuctionV2 时：

```bash
# 执行升级脚本
forge script script/upgrade/Upgrade.s.sol \
  --rpc-url $SEPOLIA_RPC_URL \
  --broadcast \
  --verify \
  --etherscan-api-key $ETHERSCAN_API_KEY
```

### 6.2 验证升级

```bash
# 检查实现合约地址是否已更改
cast call <PROXY_ADDRESS> "implementation()(address)" \
  --rpc-url $SEPOLIA_RPC_URL

# 调用 V2 特有函数验证
cast call <PROXY_ADDRESS> "getFeeTier(uint256)(uint256,uint256)" 1000 \
  --rpc-url $SEPOLIA_RPC_URL
```

### 6.3 升级注意事项

⚠️ **升级前务必：**

1. **备份当前状态**：记录所有活跃拍卖
2. **测试升级**：先在本地测试网测试升级流程
3. **通知用户**：如有活跃用户，提前通知维护时间
4. **验证代码**：确保新版本代码经过充分测试

---

## 故障排查

### 7.1 常见问题

**问题 1: Gas 不足**
```bash
Error: sender doesn't have enough funds to send tx
```

**解决方案：**
```bash
# 检查余额
cast balance <ADDRESS> --rpc-url $SEPOLIA_RPC_URL

# 获取测试 ETH
# 访问水龙头获取更多测试 ETH
```

---

**问题 2: Nonce 错误**
```bash
Error: nonce has already been used
```

**解决方案：**
```bash
# 重置 nonce（谨慎使用）
cast rpc anvil_setNextNonce <ADDRESS> <NEW_NONCE> \
  --rpc-url http://localhost:8545
```

---

**问题 3: 合约验证失败**
```bash
Error: Contract verification failed
```

**解决方案：**
```bash
# 检查构造函数参数是否正确
# 等待几分钟后重试（Etherscan 索引延迟）
# 手动验证并使用 --flatten 生成代码
forge flatten src/auction/AuctionV1.sol > flattened.sol
```

---

**问题 4: 价格预言机返回 0**
```bash
Error: Invalid price
```

**解决方案：**
```bash
# 验证价格预言机地址是否正确
cast call 0x694AA1769357215DE4FAC081bf1f309aDC325306 \
  "latestRoundData()(uint80,int256,uint256,uint256,uint80)" \
  --rpc-url $SEPOLIA_RPC_URL

# 检查价格是否正常更新
```

---

### 7.2 调试技巧

**查看交易详情：**
```bash
# 使用 cast 查看交易收据
cast receipt <TX_HASH> --rpc-url $SEPOLIA_RPC_URL

# 模拟交易调用
cast send <PROXY_ADDRESS> \
  "createAuction(address,uint256,uint256,uint256,address)" \
  <NFT_CONTRACT> <TOKEN_ID> <DURATION> <MIN_BID> <PAYMENT_TOKEN> \
  --rpc-url $SEPOLIA_RPC_URL \
  --dry-run
```

**查看事件日志：**
```bash
# 查询特定事件
cast logs <FROM_BLOCK> <TO_BLOCK> \
  "<PROXY_ADDRESS>" \
  "AuctionCreated(uint256,address,address,uint256,uint256,uint256,uint256)" \
  --rpc-url $SEPOLIA_RPC_URL
```

---

## 部署后检查清单

- [ ] NFT 合约部署成功
- [ ] 拍卖合约代理部署成功
- [ ] 拍卖合约实现部署成功
- [ ] 合约在 Etherscan 上验证
- [ ] Chainlink 价格预言机配置正确
- [ ] 手续费率设置正确
- [ ] Owner 权限验证
- [ ] 运行基本功能测试
- [ ] 记录所有合约地址
- [ ] 备份部署脚本和环境变量

---

## 下一步

部署完成后，请参考 `doc/线上测试操作指南.md` 进行合约功能测试。
